# .github/workflows/ä¸€é”®æ„å»ºå‘å¸ƒ.yml
name: ğŸš€ ä¸€é”®æ„å»ºä¸å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      BUILD_TIME:
        type: string
        description: "è‡ªå®šä¹‰æ„å»ºæ—¶é—´ (è¾“å…¥Fä½¿ç”¨å½“å‰æ—¶é—´)"
        required: false
        default: "F"
      SUFFIX:
        type: string
        description: "è‡ªå®šä¹‰å†…æ ¸åç¼€"
        required: false
        default: ""
      LSM:
        type: boolean
        description: "æ˜¯å¦å¯ç”¨å†…æ ¸å±‚é¢é˜»æ­¢å¯¹å…³é”®åˆ†åŒº/è®¾å¤‡èŠ‚ç‚¹çš„éæ³•å†™å…¥(LSM)ï¼Ÿ"
        required: true
        default: true
      SUSFS:
        type: boolean
        description: "æ˜¯å¦æ·»åŠ  SUSFS æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼Ÿ"
        required: true
        default: false

env:
  TZ: Asia/Shanghai

jobs:
  build-all:
    name: ğŸ—ï¸ æ„å»ºæ‰€æœ‰å†…æ ¸ç‰ˆæœ¬
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: 
          - { workflow: "KernelSU-NOsusfs.yml", name: "æ ‡å‡†ç‰ˆ", susfs: false }
          - { workflow: "KernelSU-susfs.yml", name: "SUSFSç‰ˆ", susfs: true }
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¯ è§¦å‘ ${{ matrix.config.name }} æ„å»º
        uses: convictional/trigger-workflow-and-wait@v1
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_file_name: ${{ matrix.config.workflow }}
          wait_interval: 60  # å¢åŠ åˆ°60ç§’æ£€æŸ¥ä¸€æ¬¡
          wait_timeout: 7200 # æ€»è¶…æ—¶æ—¶é—´2å°æ—¶
          propagate_failure: false
          trigger_workflow: true
          wait_workflow: true
          client_payload: |-
            {
              "FILE": "oneplus_ace2_v",
              "BUILD_TIME": "${{ github.event.inputs.BUILD_TIME }}",
              "SUFFIX": "${{ github.event.inputs.SUFFIX }}",
              "LSM": ${{ github.event.inputs.LSM }},
              "SUSFS": ${{ matrix.config.susfs }}
            }

      - name: â³ ç­‰å¾…å…¶ä»–æ„å»ºå®Œæˆ
        run: sleep 120  # å¢åŠ åˆ°2åˆ†é’Ÿï¼Œç¡®ä¿æ‰€æœ‰æ„å»ºéƒ½å¼€å§‹

  collect-artifacts:
    name: ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©
    runs-on: ubuntu-latest
    needs: build-all
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â³ ç­‰å¾…æœ€ç»ˆæ„å»ºå®Œæˆ
        run: |
          echo "â° ç­‰å¾…æ‰€æœ‰å†…æ ¸æ„å»ºå®Œæˆ..."
          echo "é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š60åˆ†é’Ÿ"
          sleep 3600  # ç­‰å¾…60åˆ†é’Ÿï¼Œç¡®ä¿æ‰€æœ‰æ„å»ºå®Œæˆ
          echo "âœ… ç­‰å¾…å®Œæˆï¼Œå¼€å§‹æ”¶é›†äº§ç‰©"

      - name: ğŸ” è·å–æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œ
        uses: actions/github-script@v6
        id: get-workflows
        with:
          script: |
            // è·å–æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œ
            const workflows = ['KernelSU-NOsusfs.yml', 'KernelSU-susfs.yml'];
            let allArtifacts = [];
            
            for (const workflow of workflows) {
              try {
                const { data: runs } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow,
                  status: 'completed',
                  per_page: 3
                });
                
                if (runs.workflow_runs.length > 0) {
                  const latestRun = runs.workflow_runs[0];
                  console.log(`Found ${workflow}: run ${latestRun.id}`);
                  
                  const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: latestRun.id
                  });
                  
                  artifacts.artifacts.forEach(art => {
                    allArtifacts.push({
                      name: art.name,
                      workflow: workflow,
                      run_id: latestRun.id
                    });
                  });
                }
              } catch (error) {
                console.log(`Error fetching ${workflow}:`, error.message);
              }
            }
            
            console.log('All artifacts:', allArtifacts);
            return allArtifacts;

      - name: â¬‡ï¸ ä¸‹è½½æ„å»ºäº§ç‰©
        run: |
          echo "å¼€å§‹ä¸‹è½½æ„å»ºäº§ç‰©..."
          # è¿™é‡Œå®é™…å®ç°ä¸‹è½½é€»è¾‘
          mkdir -p release_files

  create-chinese-release:
    name: ğŸ‰ åˆ›å»ºä¸­æ–‡å‘å¸ƒç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: collect-artifacts
    timeout-minutes: 120  # è®¾ç½®ä½œä¸šè¶…æ—¶æ—¶é—´
    steps:
      - name: ğŸ“… è·å–ä¸­æ–‡æ—¥æœŸ
        id: date
        run: |
          CURRENT_DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
          DAY_OF_WEEK=$(TZ='Asia/Shanghai' date '+%u')
          case $DAY_OF_WEEK in
            "1") WEEKDAY="æ˜ŸæœŸä¸€" ;;
            "2") WEEKDAY="æ˜ŸæœŸäºŒ" ;;
            "3") WEEKDAY="æ˜ŸæœŸä¸‰" ;;
            "4") WEEKDAY="æ˜ŸæœŸå››" ;;
            "5") WEEKDAY="æ˜ŸæœŸäº”" ;;
            "6") WEEKDAY="æ˜ŸæœŸå…­" ;;
            "7") WEEKDAY="æ˜ŸæœŸæ—¥" ;;
          esac
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "weekday=$WEEKDAY" >> $GITHUB_OUTPUT
          echo "build_id=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»ºä¸­æ–‡å‘å¸ƒç‰ˆæœ¬
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: åˆé›†-v${{ github.run_number }}
          name: "ğŸ¯ ä¸€åŠ  Ace 2 å†…æ ¸åˆé›† - ${{ steps.date.outputs.weekday }}æ„å»º"
          body: |
            # ğŸš€ ä¸€åŠ  Ace 2 å†…æ ¸ä¸€é”®æ„å»ºåˆé›†

            ## â±ï¸ æ„å»ºä¿¡æ¯
            - **æ„å»ºç¼–å·**: #${{ github.run_number }}
            - **æ„å»ºæ—¥æœŸ**: ${{ steps.date.outputs.current_date }}
            - **æ„å»ºæ—¶é•¿**: çº¦45-60åˆ†é’Ÿ
            - **å†…æ ¸åç¼€**: ${{ github.event.inputs.SUFFIX || 'éšæœºåç¼€' }}

            ## âš™ï¸ åŠŸèƒ½ç‰¹æ€§
            | åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
            |------|------|------|
            | LSMä¿æŠ¤ | ${{ github.event.inputs.LSM && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} | å†…æ ¸çº§åˆ†åŒºä¿æŠ¤ |
            | SUSFSæ”¯æŒ | ${{ github.event.inputs.SUSFS && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} | ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ |
            | KernelSU | âœ… å·²é›†æˆ | å†…æ ¸çº§Rootæ–¹æ¡ˆ |
            | BBRåŠ é€Ÿ | âœ… å·²å¯ç”¨ | ç½‘ç»œä¼ è¾“ä¼˜åŒ– |
            | åŸºå¸¦ä¿æŠ¤ | âœ… å·²å¯ç”¨ | é€šä¿¡æ¨¡å—å®‰å…¨ |

            ## ğŸ“¦ åŒ…å«ç‰ˆæœ¬
            - **KernelSU æ ‡å‡†ç‰ˆ** - ç¨³å®šå¯é ï¼Œæ—¥å¸¸ä½¿ç”¨
            - **KernelSU SUSFSç‰ˆ** - æ”¯æŒSUSFSæ–‡ä»¶ç³»ç»Ÿ

            ## ğŸ”§ åˆ·æœºè¯´æ˜
            1. ğŸ”‹ ç¡®ä¿ç”µé‡å……è¶³ (>50%)
            2. ğŸ’¾ å¤‡ä»½é‡è¦æ•°æ®
            3. ğŸ”“ è¿›å…¥Recoveryæ¨¡å¼
            4. ğŸ“¦ åˆ·å…¥å¯¹åº”zipæ–‡ä»¶
            5. ğŸ”„ é‡å¯è®¾å¤‡

            âš ï¸ **æ³¨æ„**: æ„å»ºè¿‡ç¨‹çº¦éœ€45-60åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…

            ---
            *è‡ªåŠ¨åŒ–æ„å»ºäº ${{ steps.date.outputs.weekday }} ${{ steps.date.outputs.current_date }}*

          draft: false
          prerelease: false
          generate_release_notes: false

      - name: âœ… å‘å¸ƒå®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ å‘å¸ƒåˆ›å»ºæˆåŠŸï¼"
          echo "â±ï¸ æ€»æ„å»ºæ—¶é—´: çº¦60åˆ†é’Ÿ"
          echo "ğŸ“ å‘å¸ƒåœ°å€: ${{ steps.create_release.outputs.url }}"